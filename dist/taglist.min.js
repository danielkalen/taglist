!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("quickdom"),require("popper.js"),require("error-ex")):"function"==typeof define&&define.amd?define(["exports","quickdom","popper.js","error-ex"],e):e((t=t||self).taglist={},t.DOM$1,t.Popper,t.errorEx)}(this,function(t,e,i,n){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,i=i&&i.hasOwnProperty("default")?i.default:i,n=n&&n.hasOwnProperty("default")?n.default:n;var s={boundingEl:document.body,tagLabel:"Option",requireDefaults:!1,templates:null,defaults:null,tags:null,fontFamily:"inherit",button:{bgColor:"#f74425",textColor:"#fff"}},o=e.template(["div",{ref:"addButton",style:{position:"relative",display:"inline-block",verticalAlign:"top",height:"28px",width:"28px",boxSizing:"border-box"}},["div",{style:{height:"100%",width:"100%",border:"2px dashed",borderRadius:"5px",boxSizing:"border-box",cursor:"pointer",userSelect:"none",opacity:.35,color:"#181818"}},["div",{ref:"TagListButtonText",style:{position:"absolute",left:0,right:0,top:"55%",transform:"translate(0, -50%)",width:"100%",lineHeight:1,textAlign:"center",fontSize:"23px",fontWeight:600}},"+"]]]),r=e.template(["div",{ref:"TagList",style:{position:"relative",textAlign:"left",fontFamily:function(t){return t.settings.fontFamily}}},o]),l=e.template(["div",{ref:"button",style:{position:"relative",height:50,borderRadius:"0 0 5px 5px",boxSizing:"border-box",cursor:"pointer",userSelect:"none",backgroundColor:function(t){return t.settings.button.bgColor},color:function(t){return t.settings.button.textColor}},computers:{height:function(t){return this.style({height:t})}}},["div",{ref:"buttonText",style:{position:"absolute",top:"53%",transform:"translate(0, -50%)",display:"block",width:"100%",fontSize:14,lineHeight:1,fontWeight:400,textAlign:"center",textTransform:"uppercase",letterSpacing:"1.5px"},computers:{text:function(t){return this.text=t},size:function(t){return this.style({fontSize:t})},font:function(t){return this.style({fontFamily:t})}}}]]),a=e.template(["div",{ref:"TagList-Popup",style:{position:"relative",zIndex:2001,backgroundColor:"white",borderRadius:"5px",boxShadow:"0px 3px 18px rgba(0,0,0,0.24)",boxSizing:"border-box",fontFamily:function(t){return t.settings.fontFamily}}},["div",{ref:"content"}]]),u=function(){class t extends(require("event-lite")){constructor(t,e,n){super(),this.parent=t,this.settings=e,this.state={open:!1},this.el=a.spawn(null,{relatedInstance:this}),this.el.hide().appendTo(this.parent),this.popper=new i(this.parent[0],this.el[0],{placement:"bottom",trigger:"manual",modifiers:{offset:{enabled:!0,offset:"5px"},preventOverflow:{enabled:!0,boundriesElement:n[0]||n}}})}_attachOuterClickListener(){return e(document).on("click.outerClick",t=>{if(!e(t.target).parents.includes(this.parent))return this.close(),this.emit("blur")})}_detachOuterClickListener(){return e(document).off("click.outerClick")}open(){if(!this.state.open)return this.emit("beforeopen"),this.state.open=!0,this.el.show(),this.popper.update(),this._attachOuterClickListener(),this.emit("open"),this}close(){if(this.state.open)return this.emit("beforeclose"),this.state.open=!1,this.el.hide(),this._detachOuterClickListener(),this.emit("close"),this}setContent(t){if(this.els.content.empty(),t)return this.els.content.append(t)}}return Object.defineProperties(t.prototype,{els:{get:function(){return this.el.child}}}),t}.call(void 0);var h=e.template(["div",{ref:"button"},["div",{ref:"errorMessage",style:{boxSizing:"border-box",display:"none",padding:"10px 15px",fontSize:12,fontWeight:500,color:"#f74425"},methods:{set:function(t){return this.html=t,this.show(),clearTimeout(this._timeout),this._timeout=setTimeout(()=>this.clear(),8e3)},clear:function(){return this.text="",this.hide()}}}],l.extend({ref:"button_"},["div",{style:{backgroundColor:"#d4d4d4",$hover:{backgroundColor:function(t){return t.settings.button.bgColor}}}}])]),p=e.template(["div",{ref:"removeButton",style:{position:"absolute",right:"8px",top:"55%",transform:"translate(0, -50%)",fontSize:"17px",lineHeight:1,opacity:.4,fontWeight:600}},"Ã—"]),d=e.template(["div",{ref:"text",style:{position:"relative",top:"9px",fontSize:"13.2px",lineHeight:1}},["span",{ref:"label",style:{fontWeight:600}}],["span",{ref:"value"}]]),c=e.template(["div",{ref:"tagContent",style:{boxSizing:"border-box",padding:function(t){return`${t.settings.padding}px`},maxWidth:function(t){return`${t.settings.maxWidth}px`}}}]),f=e.template(["div",{ref:"tag",style:{position:"relative",display:"inline-block",verticalAlign:"top",height:"28px",marginRight:"10px",marginBottom:"6px",padding:"0 25px 0 10px",borderRadius:"4px",textAlign:"center",boxSizing:"border-box",cursor:"pointer",userSelect:"none",backgroundColor:function(t){return t.settings.bgColor},color:function(t){return t.settings.textColor},fontFamily:function(t){return t.settings.fontFamily}}},d,p]),g={bgColor:"#ccc",textColor:"#181818",updateWhen:"applied",hideLabel:!1,padding:20,maxWidth:350},b={getter:function(){return this.field.value},setter:function(t){return this.field.value=t},validate:function(t){return null!=t}},m=n("ValidationError"),v=function(){class t extends(require("event-lite")){constructor(t,e){var i,n;super(),i=z.keys(["button","fontFamily"]).clone(e),n=z.keys(["padding","maxWidth"]).clone(t),this.settings=z.clone(g,e.tag,i,n),this.option=z.clone(b,t),this.option.popup=z.clone(e.popup,this.option.popup),this.state={},this.name=this.option.name,this.label=this.option.label,this.el=f.spawn(null,{relatedInstance:this}),this.content=c.spawn(null,{relatedInstance:this}),this.button=h.spawn({data:{text:"Apply"}},{relatedInstance:this}),this.popup=new u(this.el,e,e.boundingEl),this.popup.setContent(this.content),"applied"===this.settings.updateWhen&&this.button.insertAfter(this.content),this._setup(),this._attachBindings()}_setup(){return this.option.hideLabel?this.els.label.hide():this.els.label.html=`${this.option.label}: `}_attachBindings(){if(this.els.removeButton.on("click",t=>(this.emit("remove"),t.stopPropagation())),this.el.on("click",()=>this.popup.open()),this.button.on("click",t=>{if(t.stopPropagation(),this._applyChanges())return this.popup.close()}),"applied"===this.settings.updateWhen)return this.popup.on("open",()=>{var t;return null!=(t=this.state).valueOnFocus?t.valueOnFocus:t.valueOnFocus=this.value}),this.popup.on("blur",()=>{if(this.value!==this.state.valueOnFocus&&!this._applyChanges())return console.log("opening"),this.popup.open()})}_initField(){if(this.field=this.option.field.call(this,this.content.raw,function(t){var e;return(e=function(t){return e.tag._updateFromField(t)}).tag=t,e}(this)),this.option.default)return this.set(this.option.default,!0)}_domInsert(t,e){return this.el[t](e),this._initField(),this}_notifyChange(){return this.emit("change",this.value)}_updateText(t){return this.els.value.text=function(t,e){var i;switch(!1){case void 0!==e:return t;case"function"!=typeof e:return e(t);case!Array.isArray(e):return(i=e.find(function(e){return e.value===t}))?i.label||i.name:t;case!("object"==typeof e&&e):return e[t]||t}}(t,this.option.formatter)}_updateFromUser(t,e){if(this._updateText(t),this.option.setter.call(this,t),!e)return this._notifyChange()}_updateFromField(t){if(this._updateText(t),"applied"!==this.settings.updateWhen)return this._notifyChange()}_applyChanges(){var t;return!0===(t=this.validate())?(this.state.valueOnFocus=null,this._notifyChange(),!0):t instanceof Error?(this.button.child.errorMessage.set(t.message),this.emit("error",t),!1):void 0}get(t){var e;return e=this.option.getter.call(this),this.option.transformOutput&&!t&&(e=this.option.transformOutput(e)),e}set(t,e){return"function"==typeof t&&(t=t()),this.option.transformInput&&(t=this.option.transformInput(t)),this._updateFromUser(t,e)}validate(){var t;if(!this.option.validate)return!0;try{t=this.option.validate.call(this,this.value)}catch(e){t=e}switch(!1){case!0!==t:return!0;case!1!==t:return new m("validation failed");case"string"!=typeof t:return new m(t);case!(t instanceof Error):return t}}appendTo(t){return this._domInsert("appendTo",t)}prependTo(t){return this._domInsert("prependTo",t)}insertBefore(t){return this._domInsert("insertBefore",t)}insertAfter(t){return this._domInsert("insertAfter",t)}}return Object.defineProperties(t.prototype,{els:{get:function(){return this.el.child}},value:{get:function(){return this.get()}},rawValue:{get:function(){return this.get(!0)}}}),t}.call(void 0),y=(l.extend(["div",{computers:{_init:function(){return this.applyData({text:`Add ${this.related.settings.itemLabel}`})}}}]),e.template(["div",{ref:"arrow",style:{position:"absolute",zIndex:2,right:"15px",top:"54%",transform:"translate(0, -50%)",width:"17px",height:"17px",backgroundSize:"100%",backgroundImage:"url(data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTguMS4xLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDMwOS4xNTYgMzA5LjE1NiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMzA5LjE1NiAzMDkuMTU2OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjY0cHgiIGhlaWdodD0iNjRweCI+CjxnPgoJPGc+CgkJPHBvbHlnb24gcG9pbnRzPSIyODguNDYxLDY0LjkyOSAxNTQuNTg5LDIwMi43NjYgMjAuNzIzLDY0Ljk0IDAsODUuMDcgMTU0LjU4OSwyNDQuMjI4IDMwOS4xNTYsODUuMDcgICAiIGZpbGw9IiMwMDAwMDAiLz4KCTwvZz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8L3N2Zz4K)",opacity:.5}}])),x=e.template(["div",{ref:"fake",style:{position:"absolute",zIndex:1,left:0,top:"53%",transform:"translate(0, -50%)",height:"16px",padding:"0 15px",fontSize:"16px",fontWeight:500,lineHeight:1,textAlign:"left",userSelect:"none",boxSizing:"border-box",color:"#181818",opacity:.6,$hasContent:{opacity:1}}}]),_=e.template(["select",{ref:"input",forceStyle:!0,style:{position:"absolute",zIndex:3,top:0,left:0,width:"100%",height:"100%",opacity:0},computers:{_init:function(){return e.option({props:{value:""}},`Select ${this.related.settings.tagLabel}`).appendTo(this)}},methods:{label:{get:function(){var t,e;return e=this.raw.selectedIndex||0,null!=(t=this.raw.options[e])?t.label:void 0}},value:{get:function(){return this.raw.value},set:function(t){return this.raw.value=t}}}}]),C=e.template(["div",{ref:"selectField",style:{position:"relative",minWidth:230,height:"55px",borderBottom:"1px solid #ddd"}},y,x,_]),w=function(){class t extends(require("event-lite")){constructor(t){super(),this.settings=t,this.field=C.spawn(null,{relatedInstance:this}),this.input=this.field.child.input,this._attachBindings(),this._setUiLabel(this.label)}_attachBindings(){return this.field.on("input",()=>this.emit("change",{label:this.label,value:this.value})),this.on("change",function({label:t}){return this._setUiLabel(t)})}_setUiLabel(t){return this.field.child.fake.html=t}_setValue(t){return this.input.value=t,this._setUiLabel(this.label)}setOptions(t){var i,n,s,o,r;for((r=this.input.children.slice(1)).length&&e.batch(r).remove(),i=0,s=t.length;i<s;i++)({name:o,label:n}=t[i]),this.input.append(e.option({props:{value:o}},n))}insertBefore(t){return this.field.insertBefore(t)}}return Object.defineProperties(t.prototype,{label:{get:function(){return this.input.label}},value:{get:function(){return this.input.value},set:function(t){return this._setValue(t)}}}),t}.call(void 0),P=function(){class t extends(require("event-lite")){constructor(t){super(),this.list=t,({settings:this.settings}=this.list),this.content=c.spawn(null,{relatedInstance:this}),this.state={},this.applyButton=this.button=h.spawn({data:{text:`Add ${this.settings.tagLabel}`}},{relatedInstance:this}),this.addButton=this.list.els.addButton,this.popup=new u(this.addButton,this.settings,this.settings.boundingEl),this.selectField=new w(this.settings),this.content_=DOM.div(null,this.content),this.selectField.insertBefore(this.content),this.applyButton.insertAfter(this.content),this.popup.setContent(this.content_),this._setup()}_setup(){return this.applyButton.on("click",()=>{if(this._validateHasField())return this._applyChanges()}),this.addButton.on("click",()=>this.popup.open()),this.selectField.on("change",({value:t})=>this._setCurrent(t))}_setCurrent(t){if(this.content.empty(),this.option=this.list._findOption(t),this.option?(this.option=z.clone(b,this.option),this._initField()):this.field=null,this.selectField.value!==t)return this.selectField.value=t}_validateHasField(){return!!this.field||(this.button.child.errorMessage.set("You must select a field first"),!1)}_updateSelectable(){var t;return t=this.settings.repeatableValues?this.list.options:this.list.options.filter(({name:t})=>this.list._findTag(t)),this.selectField.setOptions(t)}_notifyChange(){return this.emit("change",this.option,this.value),this._reset()}_updateFromUser(t){return this.option.setter.call(this,t)}_updateFromField(t){}_reset(){return this._setCurrent(""),this.popup.close()}}return t.prototype.get=v.prototype.get,t.prototype.set=v.prototype.set,t.prototype.validate=v.prototype.validate,t.prototype._initField=v.prototype._initField,t.prototype._applyChanges=v.prototype._applyChanges,Object.defineProperties(t.prototype,{els:{get:function(){return this.el.child}},value:{get:function(){return this.get()}}}),t}.call(void 0),I=function(t){var e,i,n;if(Array.isArray(t))return t;for(e in i=[],t)n=t[e],i.push({name:e,value:n});return i},z=function(){class t extends(require("event-lite")){constructor(t,i=[],n){var o,l,a,u;for(super(),this.targetContainer=t,this.options=i,this.settings=z.deepOnly("button").clone(s,n),this.settings.boundingEl=e(this.settings.boundingEl),this.settings.defaults=I(this.settings.defaults||[]),this.tags=[],this.el=r.spawn(null,{relatedInstance:this}),this.buffer=new P(this),o=0,l=(u=this.options).length;o<l;o++)null==(a=u[o]).name&&(a.name=a.label);this._applyDefaults(this.settings.defaults),this._attachBindings(),this.el.appendTo(this.targetContainer),this.buffer._updateSelectable()}_attachBindings(){if(this.buffer.on("change",(t,e)=>(this.add(t,e),this._notifyChange())),this.buffer.popup.on("beforeopen",()=>this.closeAllPopups()),this.on("change",()=>this.buffer._updateSelectable()),this.settings.onChange)return this.on("change",this.settings.onChange)}_applyDefaults(t){var e,i,n,s,o;for(e=0,i=(t=I(t)).length;e<i;e++)({name:n,value:o}=t[e]),o&&(s=this._findOption(n),"function"==typeof o&&(o=o()),this.add(s,o))}_notifyChange(t){if(!t)return this.emit("change",this.getValues(!0))}_findOption(t,e=this.options){return e.find(function(e){return e.name===t})}_findTag(t,e=this.tags){return e.find(function(e){return e.name===t})}_findDefault(t){return this.settings.defaults.find(function(e){return e.name===t})}addOption(t){if(!this._findOption(t.name))return this.options.push(t)}add(t,e){var i;return"string"==typeof t&&(t=this._findOption(t)),(i=new v(t,this.settings)).insertBefore(this.els.addButton),null!=e&&i.set(e,!0),i.once("remove",()=>this.remove(i)),i.on("change",()=>this._notifyChange()),i.popup.on("beforeopen",()=>this.closeAllPopups()),this.tags.push(i)}remove(t,e){var i;"string"==typeof t&&(t=this.tagsByName[t]),t.popup.close(),i=this.tags.indexOf(t),this.settings.requireDefaults&&this._findDefault(t.name)?(t.set(this._findDefault(t.name),!0),this.tags.splice(i,1,t)):(t.el.remove(),this.tags.splice(i,1)),this._notifyChange(e)}removeAll(t){var e,i,n,s;for(e=0,i=(n=this.tags.slice()).length;e<i;e++)s=n[e],this.remove(s,!0);this._notifyChange(t)}setValues(t,e){var i,n,s,o,r,l;for(n=i=0,s=(r=I(t)).length;i<s;n=++i)({name:o,value:l}=r[n]),this.setValue(o,l,!0,n);return this._notifyChange(e)}setValue(t,e,i,n){var s,o;return s=n?this.tags.slice(n):this.tags,(o=this._findTag(t,s))?o.set(e,!0):this._findOption(t)&&this.add(t,e),this._notifyChange(i)}replaceValues(t,e){return this.removeAll(!0),this.setValues(t,!0),this._notifyChange(e)}getValues(){return this.tags.map(function(t){return{name:t.name,value:t.value}})}closeAllPopups(){var t,e,i;for(this.buffer.popup.close(),t=0,e=(i=this.tags).length;t<e;t++)i[t].popup.close()}destroy(){this.closeAllPopups(),this.el.remove(),this.emit("destroy")}}return Object.defineProperties(t.prototype,{els:{get:function(){return this.el.child}},tagsByName:{get:function(){var t;return t=this.tags,new function(){var e,i,n;for(e=0,i=t.length;e<i;e++)this[(n=t[e]).name]=n;return this}}}}),t}.call(void 0);t.BufferTag=P,t.Popup=u,t.Tag=v,t.default=z,t.version="3.0.3",Object.defineProperty(t,"__esModule",{value:!0})});